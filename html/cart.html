<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="../css/style.css" rel="stylesheet" type="text/css">
  <title>Museum Cart</title>
</head>

<body class="mainpage">
  <header>
    <h1>Shopping Cart</h1>
  </header>

  <main>
    <!-- NEW CONTROLS (Cart page only) -->
    <div class="controls">
      <label><input type="checkbox" id="memberToggle"> Member Discount (15%)</label>
    </div>

    <!-- STATES & OUTPUT AREAS -->
    <div id="emptyMsg" class="empty" hidden>Your cart is empty.</div>
    <div id="items" hidden></div>
    <pre id="summary" hidden></pre>

    <!-- BASIC ACTIONS -->
    <div class="actions">
      <button id="clearBtn">Clear Cart</button>
      <a href="../html/shop.html">Keep Shopping</a>
    </div>
  </main>

  <script>
    /* =================== PIPE FROM shop.html (leave as-is) =================== */
    // shop.html must write items with: data-id, data-name, data-price, data-image
    // addToCart(btn) should push objects { id, name, unitPrice, qty, image } to localStorage

    const CART_KEY = 'museumCartV1'; // MUST match shop.html

    function readCart() {
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
      catch { return []; }
    }
    function writeCart(cart) {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    }
    /* ================= END PIPE ============================================= */


    /* ====================== UTILITIES & CONSTANTS =========================== */
    // Currency with parentheses for negatives
    function money(n) {
      const sign = n < 0 ? -1 : 1;
      const s = '$' + Math.abs(n).toFixed(2);
      return sign < 0 ? '(' + s + ')' : s;
    }

    // Spec constants
    const TAX_RATE = 0.102;
    const MEMBER_DISCOUNT_RATE = 0.15;
    const SHIPPING_RATE = 25.00;
    const VOLUME_TIERS = [
      [0.00, 49.99, 0.00],
      [50.00, 99.99, 0.05],
      [100.00, 199.99, 0.10],
      [200.00, Infinity, 0.15]
    ];

    // Return the volume discount rate given an item total
    function volumeRate(total) {
      for (const [min, max, rate] of VOLUME_TIERS) {
        if (total >= min && total <= max) return rate;
      }
      return 0;
    }

    // Remove a line item entirely (qty=0 => drop row)
    function removeItem(id) {
      const next = readCart().filter(it => it.id !== id);
      writeCart(next);
      render();
    }

    // Clear cart = initial state (cart empty, member unchecked)
    function clearCart() {
      writeCart([]);
      document.getElementById('memberToggle').checked = false;
      render();
    }
    /* ================== END UTILITIES & CONSTANTS =========================== */


    /* ====================== STUDENT WORK STARTS HERE =========================
       IMPLEMENT render() to mirror the commission assignment:
  
       1) Load cart from readCart(); keep only items with qty > 0 and unitPrice > 0
       2) If empty → show #emptyMsg and hide #items and #summary
       3) Build a text-only list in #items:
             Example line: "2 × Celestial Inkstone               $29.90"
             Include a small Remove button per line that calls removeItem(id)
       4) Math (single-discount rule):
             ItemTotal = sum(unitPrice * qty)
             If Member checked AND Volume tier would apply → PROMPT user to choose:
               "Only one discount may be applied. Type 'M' for Member or 'V' for Volume:"
               Apply only the chosen one; set the other to $0.00
             Else apply Member OR Volume (not both)
             Subtotal = ItemTotal − AppliedDiscount + SHIPPING_RATE
             TaxAmount = Subtotal * TAX_RATE
             InvoiceTotal = Subtotal + TaxAmount
       5) Write a single summary block to #summary (like commission):
             Subtotal of Items
             Volume Discount
             Member Discount
             Shipping
             Subtotal (Taxable)
             Tax Rate %   (as a percentage text)
             Tax Amount $ (as currency)
             Invoice Total
       6) Recompute (call render()) after:
             - Member checkbox change
             - Clear Cart
             - Remove line item
  
       KEEP IT SIMPLE: text output only, one render pass.
    ========================================================================= */

    function render() {
      const itemsDiv = document.getElementById('items');
      const summaryPre = document.getElementById('summary');
      const emptyMsg = document.getElementById('emptyMsg');
      const isMember = document.getElementById('memberToggle').checked;

      let customerCart = readCart() // Get the contents of the cart array.
      let cartTable = `<p>Your cart is empty.</p>`; // Will be added to for display on the page.
      let cartSummary = ``;

      if (customerCart.length !== 0) {
        cartTable = "";

        cartTable += `<table class="cart"><tr><th>Item</th><th>Qty</th><th>Unit Price</th><th>Line Total</th><th>Remove</th></tr>`;

        let memberDiscount = 0;

        if (isMember) {
          memberDiscount = 0.15;
        }

        let subTotal = 0;

        for (itemIndex in customerCart) {
          let item = customerCart[itemIndex]
          let itemName = item.name;
          let itemCount = item.qty;
          let itemPrice = item.unitPrice;
          let totalCost = itemPrice * itemCount;
          cartTable += `<tr>
            <td><img src="${item.image}"> ${itemName}</td>
            <td>${itemCount}</td>
            <td>${money(itemPrice)}</td>
            <td>${money(totalCost)}</td>
            <td><button onClick="removeItem('${item.id}')">Remove</button></td>
            </tr>
            `;
          
          subTotal += Number(totalCost);

        }

        cartTable += "</table>"
        let volumeDiscount = -subTotal * volumeRate(subTotal);
        let totalMemberDiscount = -subTotal * memberDiscount;
        let taxableTotal = volumeDiscount + totalMemberDiscount + subTotal + SHIPPING_RATE;
        let taxAmount = taxableTotal * TAX_RATE;
        let invoiceTotal = taxableTotal + taxAmount;


        cartSummary = `
          Subtotal of Item Totals: <span class="summaryTotal">${money(subTotal)}</span>
          Volume Discount: <span class="summaryTotal">${money(volumeDiscount)}</span>
          Member Discount: <span class="summaryTotal">${money(totalMemberDiscount)}</span>
          Shipping: <span class="summaryTotal">${money(SHIPPING_RATE)}</span>
          Subtotal (Taxable): <span class="summaryTotal">${money(taxableTotal)}</span>
          Tax Rate: <span class="summaryTotal">${money(TAX_RATE)}</span>
          Tax Amount: <span class="summaryTotal">${money(taxAmount)}</span>
          Invoice Total: <span class="summaryTotal">${money(invoiceTotal)}</span>
        `;

        summaryPre.hidden = false;

      }
      // TODO: STUDENT IMPLEMENTATION
      // For now, show a placeholder so the page isn't blank.
      itemsDiv.hidden = false;
      emptyMsg.hidden = true;
      itemsDiv.innerHTML = cartTable
      summaryPre.innerHTML = cartSummary;
      // `TODO: Implement render() per the assignment spec.

      // Steps:
      // 1) Load cart from localStorage (readCart)
      // 2) If empty → show 'Your cart is empty.'
      // 3) Build text list of items with Remove buttons
      // 4) Compute totals with exactly one discount (prompt if both apply)
      // 5) Output a single summary block (commission-style)`;
    }

    // Events → re-render
    document.getElementById('memberToggle').addEventListener('change', render);
    document.getElementById('clearBtn').addEventListener('click', clearCart);

    // First paint
    render();
  </script>
</body>

</html>